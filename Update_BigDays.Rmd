---
title: "Update_BigDays"
author: "Zoe Schroder"
date: "12/9/2020"
output: html_document
---

The data for the BigDays needs to be updated. Currently it only contains information from 1994 to 2018. This needs to be extended to 2020. As such, additional NARR data and climate data will need to be downloaded and added to the `RData` file. This work will closely follow that outlined in the **DefineBigDays** repository on my github page. 

The 1950 to 2018 tornado data is downloaded as a csv file from https://www.spc.noaa.gov/wcm/#data

The 2019 through September 2020 data came from the SPC National Center for Environmental Information Storm Events Database (https://www.ncdc.noaa.gov/stormevents/choosedates.jsp?statefips=-999%2CALL). 

*Load the necessary packages*

```{r}
library(sp)
library(sf)
library(lubridate)
library(dplyr)
```


Use the start lon/lat and create a `sp` object then convert to `sf`. Set the coordinate reference system (crs) to ESPG 4326.
```{r}
Torn50_19.spdf <- read.csv(file = "1950-2019_all_tornadoes.csv")
sp::coordinates(Torn50_19.spdf) <- ~ slon + slat
Torn50_19.sfdf <- st_as_sf(Torn50_19.spdf)
st_crs(Torn50_19.sfdf) <- 4326
```

In the 2020 data, we can also use the start lat and lon to creat an `sp` object. We then can convert it to `sf` data frame and set the coordinate reference system (crs) to EPSG 4326 [WGS 84]. However, we need to adjust the column headers of the 2020 tornado files to match those of the 1950 to 2019 data frame. 

Read the 2020 tornado data into R.

```{r}
Torn2020.spdf <-read.csv(file = "2020_TornadoData.csv")
```

The column headers do not match the 1950 to 2019 data frame. Therefore, you MUST rename the column headers before you can combine the data frames. Change the column names using the `colnames` function. 

```{r}
cols <- c("eventid", "county", "city", "date", "originaltime", "eventtype", "mag_NA", "mag", "fat", "inj", "loss", "closs", "st", "timezone", "magtype", "epiid", "cztype", "stf", "WFO", "injind", "fatind", "source", "floodcause", "len", "wid", "brange", "bazimuth", "erange", "eazimuth", "elocation", "slat", "slon", "elat", "elon", "eventnar", "episodenar", "om")
colnames(Torn2020.spdf) <- cols
```

Convert to a spatial points data frame using the start latitude and longitude for each tornado. Next, convert to a simple features data frame with a set coordinate reference system to the WGS 84 (`EPSG: 4236`)

```{r}
sp::coordinates(Torn2020.spdf) <- ~ slon + slat
Torn2020.sfdf <- st_as_sf(Torn2020.spdf)
st_crs(Torn2020.sfdf) <- 4326
```

Adjust the date and time columns. Add columns for day (dy), month (mo), year (yr), time(CST) 

```{r}
mydates <- as.Date(c(Torn2020.sfdf$date), format = "%m/%d/%Y")

Torn2020.sfdf <-  Torn2020.sfdf %>%
  mutate(yr = rep(2020, 1131),
         dy = day(as.Date(c(date), format = "%m/%d/%Y")),
         mo = month(as.Date(c(date), format = "%m/%d/%Y")),
         mag = as.integer(substr(mag, 3,3)))
```

Convert times to the CST time zone. In the originaltime column, it has values of CST-6, EST-5, MST-7, and PST-8. Therefore, we create a `for` loop to convert these times to CST which is consistent with `Torn50_19.sfdf`.

```{r}
time <- c()

for (i in 1:1131){
  if(Torn2020.sfdf$timezone[i] == "CST-6") { 
    time <- append(time,Torn2020.sfdf$originaltime[i])
    } else if
    (Torn2020.sfdf$timezone[i] == "EST-5") {
    time <- append(time,(Torn2020.sfdf$originaltime[i] - 100))  
    }   else if(Torn2020.sfdf$timezone[i] == "MST-7") {
    time <- append(time,(Torn2020.sfdf$originaltime[i] + 100))
    }    else if(Torn2020.sfdf$timezone[i] == "PST-8") {
    time <- append(time,(Torn2020.sfdf$originaltime[i] + 200))
    } else ("NA")
}

time <- format(strptime(substr(as.POSIXct(sprintf("%04.0f", time), format="%H%M"), 12, 16), '%H:%M'), '%I:%M:%S %p')
time <- format(strptime(time, "%I:%M:%S %p"), "%H:%M:%S")

x<-as.POSIXct(time,format="%H:%M:%S")
hour <- hour(x)
tz <- rep(3, 1131)

Torn2020.sfdf <- cbind(Torn2020.sfdf, time, hour, tz)
```

**YOU need to convert to the correct time. Get hour. and add to torn2020.sfdf

```{r}
colnames(Torn50_19.sfdf)
```

```{r}
colnames(Torn2020.sfdf)
```

```{r}
filter_cols <- c("om","yr", "mo", "dy", "date", "tz", "st", "stf", "mag","inj", "fat", "loss", "closs", "elat", "elon", "len", "wid", "geometry")

Torn50_19.sfdf <-  Torn50_19.sfdf %>%
  dplyr::select(filter_cols)

Torn2020.sfdf <-  Torn2020.sfdf %>%
  dplyr::select(filter_cols)
#stn sn, ns, sg, f1m f2, f3, fc were removed from the 1950:2019 data file. 

Torn.sfdf <- as.data.frame(rbind(Torn50_19.sfdf, Torn2020.sfdf))
```


We need to combine the 2019, 2020 and 1950 to 2018 data frames. However, the column headers do not match. The first thing to do is correct this issue. 

```{r}
columns <- colnames(Torn.sfdf)
```

