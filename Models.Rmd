---
title: "Influence of climate indicators on tornado 'outbreak' environments"
author: "Zoe Schroder"
date: "3/3/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
load("BigDays.RData")
```

**Set the mercator projection for all figures**
```{r}
merc =  "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
WGS84 <- 4326
```

Load all libraries needed for this research: 
```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(sf)
library(GGally)
library(USAboundaries)
library(tmap)
library(xtable)
library(lme4)
library(gridExtra)
```

*Set the coordinate reference system to WGS84*
```{r}
st_crs(BigDays.sfdfT) <- WGS84
```

#Look at the annual trends in climate variables. 
*Yearly trends in climate variables*
```{r}
library(dplyr)
x <-  BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(maxSIE = max(SIE))

SIEgraph <- ggplot(x, (aes(x = Year, y = maxSIE))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "red", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2020,1))) +
  scale_y_continuous(limits = c(14, 16), breaks = c(seq(14,16,0.25))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Maximum Sea Ice Extent [millions of square km]")

SIEgraph <- SIEgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
#SIEgraph
```

```{r}
x <-  BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(maxNino = max(ElNino34))

Ninograph <- ggplot(x, (aes(x = Year, y = maxNino))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "blue", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2020,1))) +
  scale_y_continuous(limits = c(26.5, 30), breaks = c(seq(26.5,30,0.5))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab(" Maximum El Nino 3.4 Index")

Ninograph <- Ninograph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
#Ninograph
```

```{r}
x <-  BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(maxairtemp = max(avg_airtemp))

airtempgraph <- ggplot(x, (aes(x = Year, y = maxairtemp))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "blue", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2020,1))) +
  scale_y_continuous(limits = c(0,1.5), breaks = c(seq(0,1.5,0.25))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Maximum Air Temperature Anomalies")

airtempgraph <- airtempgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
#airtempgraph
```

```{r}
x <-  BigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(maxSST = max(SSTgradient))

SSTgraph <- ggplot(x, (aes(x = Year, y = maxSST))) +
 geom_smooth(method = lm, span = .5, se = FALSE, color = "blue", size = 1) +
  geom_line(color = "black", lwd = 1) +
  scale_x_continuous(expand = c(0, 0), breaks = c(seq(1994,2020,1))) +
  scale_y_continuous(limits = c(34,50.2), breaks = c(seq(34,50,2))) + 
#  geom_smooth(aes(x = week, y = probs/100), span = .5, se = FALSE, color = "gray70", size = 1) +
  theme_bw() +
  xlab("Year") +
  ylab("Maximum SST gradient [degrees C]")

SSTgraph <- SSTgraph + theme(axis.title.y = element_text(colour = "black"), axis.text.y = element_text(color = "black"),  axis.text.x = element_text(angle = 45, hjust = 1), axis.text = element_text(size = 12), axis.title=element_text(size=14))
#SSTgraph
```



```{r}
ggarrange(SIEgraph, Ninograph, airtempgraph, SSTgraph, ncol = 2, nrow = 2)
```

#The Models: 

*Check the distributions of the response variables: *

`CAPE`
```{r}
plot_CAPE <- ggplot(BigDays.sfdfT, aes(maxCAPE)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,7000)) +
  #scale_x_log10() + 
  xlab("Maximum CAPE [J/kg]") +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50), labels = c("0", "10", "20", "30", "40", "50"), limits = c(0, 50)) +
  ylab("Number of Clusters") + 
  ggtitle("A") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

`Deep Layer Shear`
```{r}
plot_DLBS <- ggplot(BigDays.sfdfT, aes(maxBS_deep)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,50)) +
  #scale_x_log10() + 
  xlab("Maximum Deep Layer Bulk Shear [m/s]") +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50, 60), labels = c("0", "10", "20", "30", "40", "50", "60"), limits = c(0, 60)) +
  ylab("Number of Clusters") + 
  ggtitle("C") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

`Shallow Layer Shear`
```{r}
plot_SLBS <- ggplot(BigDays.sfdfT, aes(maxBS_shallow)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,40)) +
  #scale_x_log10() + 
  xlab("Maximum Shallow Layer Bulk Shear [m/s]") +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50), labels = c("0", "10", "20", "30", "40", "50"), limits = c(0, 50)) +
  ylab("Number of Clusters") + 
  ggtitle("D") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

`CIN`
```{r}
plot_CIN <- ggplot(BigDays.sfdfT, aes(minCIN)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(-700,50)) +
  #scale_x_log10() + 
  xlab("Minimum CIN [J/kg]") +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 20,40,60,80,100), labels = c("0", "20", "40", "60", "80", "100"), limits = c(0, 100)) +
  ylab("Number of Clusters") + 
  ggtitle("B") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

*Combine the distributions into a single figure.*
```{r}
ggarrange(plot_CAPE, plot_CIN, plot_DLBS, plot_SLBS, ncol = 2, nrow = 2)
```


*What is the correlation between the climate variables? *
```{r}
ClimVars <- data.frame(AirTemperature = BigDays.sfdfT$avg_airtemp, ATL_SST = BigDays.sfdfT$Atlantic_SST, GAK_SST = BigDays.sfdfT$GAK_SST, ArcticSIE = BigDays.sfdfT$SIE, ElNino = BigDays.sfdfT$ElNino34)
```

*Create a figure to show correlations between the climate variables. *
```{r}
library(corrplot)
names(ClimVars)[names(ClimVars) == 'AirTemperature'] <- 'AirTemp'

corrplot.mixed(cor(ClimVars), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)

```

*There is a strong correlation between Caribbean sea surface temperature (ATL_SST) and Gulf of Alaska sea surface temperatures (GAK_SST). Therefore, we need to account for this. We do this by creating a new variable that is the gradient between ATL_SST and GAK_SST. *
```{r}
BigDays.sfdfT <- BigDays.sfdfT %>%
  mutate(SSTgradient = Atlantic_SST - GAK_SST)
```

*Now let's look at the correlation matrix again: *
```{r}
ClimVars2 <- data.frame(AirTemperature = BigDays.sfdfT$avg_airtemp, SSTgradient = BigDays.sfdfT$SSTgradient, ArcticSIE = BigDays.sfdfT$SIE, ElNino = BigDays.sfdfT$ElNino34)

names(ClimVars2)[names(ClimVars2) == 'AirTemperature'] <- 'AirTemp'

corrplot.mixed(cor(ClimVars2), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

There is a significant correlation of 0.69 between the SSTgradient and ArcticSIE. `SIE is the monthly Sea Ice Index which provides a quick look at Arctic-wide changes in sea ice. It is a source for consistently processed ice extent and concentration images and data values since 1979.`

This relationship indicates that the stronger the gradient in SST between the Caribbean and the Gulf of Alaska the more Arctic Sea Ice. The large correlation between these two climate variables will cause a collinearity issue in our models. As a result, one of these variables should be removed. I remove the ArcticSIE variable because it makes less physical sense. The SST gradient implies a larger magnitude of Rossby waves that can influence intense convection across the United States. 

```{r}
ClimVars3 <- data.frame(AirTemp = BigDays.sfdfT$avg_airtemp, SSTgradient = BigDays.sfdfT$SSTgradient, ElNino = BigDays.sfdfT$ElNino34)


corrplot.mixed(cor(ClimVars3), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

All collinearity issues have been removed. 

*What is the relationship between these variables and CAPE? *
```{r}
CAPE_env <- data.frame(AirTemp = BigDays.sfdfT$avg_airtemp, SSTgradient = BigDays.sfdfT$SSTgradient, ElNino = BigDays.sfdfT$ElNino34, CAPE = BigDays.sfdfT$maxCAPE)


corrplot.mixed(cor(CAPE_env), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

```{r}
CAPE_m1 <- lmer(maxCAPE ~ Year + avg_airtemp + SSTgradient + ElNino34 + (1|Mo), data = BigDays.sfdfT)
summary(CAPE_m1)
ranef(CAPE_m1) #There is a strong seasonal variation in CAPE values. 
```

```{r}
CAPE_m2 <- lmer(maxCAPE ~ avg_airtemp + SSTgradient + ElNino34 + (1|Year), data = BigDays.sfdfT)
summary(CAPE_m2)
ranef(CAPE_m2) #There is a strong annual variation in CAPE values  
```

Year and Month are crossed random effects with the syntax `(1|Mo) + (1|Year)`. Each month value is in each year (*Example:* January is in 1999, 2000, ...), and every year value contains each month. (*Example:* 1999 has Jan, Feb, Mar, ...)
```{r}
CAPE_m3 <- lmer(maxCAPE ~ avg_airtemp + SSTgradient + ElNino34 + (1|Mo) + (1|Year), data = BigDays.sfdfT)
summary(CAPE_m3)
ranef(CAPE_m3)
```

```{r}
CAPE_m4 <- lmer(maxCAPE ~ SSTgradient + ElNino34 + (1|Mo) + (1|Year), data = BigDays.sfdfT)
summary(CAPE_m4)
ranef(CAPE_m4)
```

```{r}
CAPE_m5 <- lmer(maxCAPE ~ SSTgradient + (1|Mo) + (1|Year), data = BigDays.sfdfT)
summary(CAPE_m5)
ranef(CAPE_m5)
```

```{r}
AIC(CAPE_m1,CAPE_m2,CAPE_m3,CAPE_m4,CAPE_m5)
```
Using AIC It would have me believe that model 3 is significantly better than all of the others. However, ElNino and avg_airtemp are not important in describing CAPE and should be eliminated. 

*Check the residuals of model 5 of CAPE.*
```{r}
plot(residuals(CAPE_m5)) 
```
There is no relationship between the residuals.

*Make a plot of the standardized residuals for the CAPE model*
```{r}
CAPEmod.df <- fortify.merMod(model=CAPE_m5, data = getData(CAPE_m5))
CAPEmod.df$predCAPE <- predict(CAPE_m5)

p1 <- ggplot(CAPEmod.df, aes(x = .scresid)) +
  geom_histogram(binwidth = .5, color = "white", fill = "gray40") +
  xlab("Standardized Residual") + ylab("Frequency") +
  ggtitle("A") +
  theme_minimal() + theme(text = element_text(size=25))

p2 <- ggplot(CAPEmod.df, aes(x = .fitted, y = .scresid, color = factor(Mo))) +
         geom_point(size = 2) +
        # scale_x_log10() +
         scale_color_discrete(name = "Month") +
  xlab("CAPE [J/kg]") + ylab("Standardized Residual") +
  ggtitle("B") +
  theme_minimal() + theme(text = element_text(size=26))
grid.arrange(p1, p2, ncol = 2)
```
Conditional standardized residuals from the linear regression model. (A) Histogram and (B) Residuals as a function of predicted values of CAPE. The pattern in B indicates that predictions for larger values of CAPE are less accurate. 

*How does the model do compared to the actual values? *
```{r}
predictCAPE <- predict(CAPE_m5)
BigDays.sfdfT$predCAPE <- predictCAPE

cor(BigDays.sfdfT$maxCAPE, predictCAPE)
```
This model explains 60% of the variation of CAPE.

*Make a table of the model coefficients. *
```{r}
CAPEmod_coefs <- summary(CAPE_m5)
xtable(CAPEmod_coefs$coefficients, digits = 3)
```

For every one unit increase in the SST gradient, CAPE decreases by ~48 J/kg [-85, -10, 95%]. In lay person terms: A larger temperature gradient between Caribbean waters and Gulf of Alaska waters lead to less CAPE. 

*What are the confidence intervals for the model? *
```{r}
confint(CAPE_m5)
```
                 2.5 %      97.5 %
.sig01       116.05188  344.585200
.sig02       404.82390  970.661008
.sigma      1045.33397 1153.470915
(Intercept) 1993.62141 4250.384650
SSTgradient  -84.77256   -9.986546

*Plot the observed vs Predicted values of CAPE*
```{r}
ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxCAPE, 
                 y = predCAPE), 
             size = 5, 
             show.legend = FALSE,  
             stroke = 0, 
             alpha = 0.8) +
      scale_colour_gradient(low = "lightskyblue", 
                             high = "blue") +
  geom_abline(slope = 1, 
                  size = 1.25,
              col = "blue") + 
  ylab("Estimated CAPE [J/kg]") + 
      xlab("Observed CAPE [J/kg]") +
      theme_minimal() + 
      theme(text = element_text(size=15))
```


