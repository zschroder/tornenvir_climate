---
title: "Influence of climate indicators on tornado 'outbreak' environments"
author: "Zoe Schroder"
date: "5/1/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

**Make sure to answer these questions in the Introduction: **
Tornadoes will become more destructive in a warmer world. 
    1. How do you know this?
    2. Why is this important?
    3. How does this influence your research?
    
Environmental factors have been linked to individual climate change factors including....
    1. Cite the important literature
    2. How is what you are doing different?
    3. Why is this perspective so important? 

##Introduction: ##
    
Tornado outbreaks are becoming more extensive and destructive on average. Tornado days are declining annually; however, more tornadoes are occurring on these days \citep{ElsnerElsnerJagger2015, TippettEtAl2016, Moore2017, TippettCohen2016, Moore2018, MooreDeBoer2019}. \cite{SchroderElsner2019} use statistical models to quantify the role environmental conditions play in the variability of tornado outbreak characteristics, including accumulated tornado power (ATP), tornado counts, and casualties. Research suggests that ATP and tornado counts is increasing per annum \citep{SchroderElsner2019, ElsnerFrickerSchroder2018}. As a result, the risk for damage increases  \citep{ElsnerMurnaneJaggerWiden2013}. It is challenging to attribute shifts in tornado outbreak characteristics to climate change due to limited understanding between climate change and tornado outbreak environments \citep{ElsnerGuishard2014, ElsnerFrickerSchroder2018}

Researchers project severe convective weather to increase in the future due to more frequent environmental conditions \citep{DelGenioYaoJonas2007, TrappEtAl2007, HoogewindBaldwinTrapp2017, SeeleyRomps2015, DiffenbaughTrappBrooks2008, Brooks2013, SeeleyandRomps2015}. Environmental conditions include a combination of temperature and wind driven factors. CAPE and CIN are temperature-driven factors that are inversely related and represent the ability for air to rise in the atmosphere. CAPE and CIN are projected to increase due to rising surface temperatures \citep{ElsnerJaggerElsner2014, DelGenioYaoJonas2007, HoogewindBaldwinTrapp2017, Brooks2013, TrappEtAl2007, ElsnerFrickerSchroder2018}. BS and SRH are both wind-driven factors. BS represents the change in wind speed and direction over different depths of the atmosphere. BS is projected to decrease due to a limited temperature gradient between the equator and the poles \citep{Brooks2013, DiffenbaughTrappBrooks2008}. SRH represents the rotation within the storm and is projected to increase \citep{TippettEtAl2016}.  Research suggests that the decrease in bulk shear will be less than the projected increase in CAPE \citep{DelGenioYaoJonas2007, TrappEtAl2007, Brooks2013, HoogewindBaldwinTrapp2017}. As a result, favorable severe weather environments are expected to be more frequent \citep{DelGenioYaoJonas2007, TrappEtAl2007, Brooks2013, HoogewindBaldwinTrapp2017}. Researchers suggest shift in environmental factors as a result of climate change, but more work is needed to quantify and explain these potential changes. 

Limited research has been done to link climate change to tornado outbreak environments and associated characteristics. The studies that have been done do not match the scale of the outbreak. Researchers have analyzed climate change's role on severe convective weather at the storm level \citep{TrappandHoogewind2018, HoogewindBaldwinTrapp2017,DelGenioYaoJonas2007, DiffenbaughTrappBrooks2008}. Climate change is a larger scale phenomenon and should be considered with large scale physical processes such as tornado outbreaks. More work is needed to quantify how outbreak-level  environmental conditions are responding to climate change and influencing tornado outbreak characteristics (i.e., cluster severity, tornado counts, and casualty counts). 

The goal of this research is to quantify and explain the relationship between environmental conditions and climate change. We use the term cluster instead of outbreak because we do not associate the tornadoes with the synoptic setup. The objective is to understand the role of climate change on tornado cluster environments and how that change is affecting the climatology of tornado clusters. We will fit statistical models to predict tornado cluster environments using climate change factors, including sea ice extent, El Nino Southern Oscillation Index, global temperature anomalies, and western Caribbean sea surface temperatures. 


```{r}
load("BigDays.RData")
```

**Set the mercator projection for all figures**
```{r}
merc =  "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
WGS84 <- 4326
```

Load all libraries needed for this research: 
```{r}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(sf)
library(GGally)
library(USAboundaries)
library(tmap)
library(xtable)
library(lme4)
library(gridExtra)
library(corrplot)
library(sp)
```

*Set the coordinate reference system to WGS84*
```{r}
st_crs(BigDays.sfdfT) <- WGS84
```

## Descriptive Statistics

*Big Days: *

```{r}
#The average number of tornadoes per outbreak
mean(BigDays.sfdfT$nT)

#The maximum number of tornadoes per outbreak
max(BigDays.sfdfT$nT)

#What percentage of the clusters have less than the mean number of tornadoes. 
x <- BigDays.sfdfT %>%
  filter(nT <= 22)
dim(x)[1]/dim(BigDays.sfdfT)[1]
```

*What percentage of BigDayTornadoes are associated with each EF rating?*
```{r}
BigTorn = BigDayTornadoes %>%
  group_by(mag) %>%
  summarize(nT = n())

sum(BigDays.sfdfT$n0, na.rm = TRUE)/dim(BigDayTornadoes)[1] *100
#52% of the BigDayTornadoes are EF0
sum(BigDays.sfdfT$n1, na.rm = TRUE)/dim(BigDayTornadoes)[1] *100
#33% of the BigDayTornadoes are EF1
sum(BigDays.sfdfT$n2, na.rm = TRUE)/dim(BigDayTornadoes)[1] *100
#10.5% of the BigDayTornadoes are EF2
sum(BigDays.sfdfT$n3, na.rm = TRUE)/dim(BigDayTornadoes)[1] *100
#3.4% of the BigDayTornadoes are EF3
sum(BigDays.sfdfT$n4, na.rm = TRUE)/dim(BigDayTornadoes)[1] *100
#0.75% of the BigDayTornadoes are EF4
sum(BigDays.sfdfT$n5, na.rm = TRUE)/dim(BigDayTornadoes)[1] *100
#0.08% of the BigDayTornadoes are EF5
```

*what percentage of tornadoes in EF category are contained in a cluster?*
```{r}
AllTorn = All_Tornadoes %>%
  group_by(mag) %>%
  summarize(nT = n())

sum(BigDays.sfdfT$n0, na.rm = TRUE)/AllTorn$nT[1] *100
#48.56% of all EF0s occur in a cluster
sum(BigDays.sfdfT$n1, na.rm = TRUE)/AllTorn$nT[2] *100
#62% of all EF1s occur in a cluster
sum(BigDays.sfdfT$n2, na.rm = TRUE)/AllTorn$nT[3] *100
#73% of all EF2s occur in a cluster
sum(BigDays.sfdfT$n3, na.rm = TRUE)/AllTorn$nT[4] *100
#86% of all EF3s occur in a cluster
sum(BigDays.sfdfT$n4, na.rm = TRUE)/AllTorn$nT[5] *100
#87.5% of all EF4s occur in a cluster
sum(BigDays.sfdfT$n5, na.rm = TRUE)/AllTorn$nT[6] *100
#100% of all EF5s occur in a cluster
```

Clusters and NARR time
```{r}
BigDays.sfdfT %>%
  group_by(NARRZtime) %>%
  summarize(num = n(),
            totalTots = sum(nT))
dim(BigDays.sfdfT %>%
  filter(nT == 10))[1]
```

*Cluster tornadoes*
```{r}
x <- BigDays.sfdfT %>%
  filter(nT==10)
dim(x)[1]
#88 clusters have 10 tornadoes
x <- BigDays.sfdfT %>%
  filter(nT>=30)
dim(x)[1]
#166 clusters have at least 30 tornadoes
x <- BigDays.sfdfT %>%
  filter(nT>=50)
dim(x)[1]
#52 clusters have at least 50 tornadoes. 
```

*Cluster casualties*
```{r}
x <- BigDays.sfdfT %>%
  filter(GroupDayCas==0)
dim(x)[1]
#293 clusters have 0 casualties
x <- BigDays.sfdfT %>%
  filter(GroupDayCas>=30)
dim(x)[1]
#132 clusters have at least 30 casualties
x <- BigDays.sfdfT %>%
  filter(GroupDayCas>=50)
dim(x)[1]
#90 clusters have at least 50 casualties
```

Figure: Example of clusters

```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
```

May 20, 2019
ID: 201905206481
```{r}
May20 <- BigDays.sfdfT %>%
  filter(cDate == "2019-05-20", groupNumber == 6481)
May20 <- st_convex_hull(May20)

May20centroid <- BigDayCentroids.df %>%
  filter(cDate == "2019-05-20", groupNumber == 6481)

May20tornadoes <- BigDayTornadoes %>% 
  filter(cDate == "2019-05-20", groupNumber == May20centroid$groupNumber)

May20tornadoes <- May20tornadoes %>%
  mutate(Hour2 = ifelse(Hour <= 6, Hour + 24, Hour))
```

**Make a map of the May 20 tornado day. Obtain the state and county boundaries from the `USAboundaries` package. **
```{r}
May20tornadoes$Hour2 <- cut(May20tornadoes$Hour2, breaks=c(6,12,18,24,30))

May2019 <- (tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.15, .15, .15, .15)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(May20, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(May20tornadoes) +
  tm_symbols(size = 4, col = "Hour2", alpha = 0.8, palette = "BuPu", title.col = "Time [CST]", labels = c("6 to 12", "12 to 18", "18 to 24", "0 to 6"), border.alpha = 0) +
    tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2) +
tm_shape(May20centroid) +
  tm_symbols(size = 1.25, col = "black", shape = 24)  +
  tm_layout(title = "May 20, 2019 \n 49 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 1.5)
)

May2019
```

Range of values for environmental variables:
```{r}
max(BigDays.sfdfT$maxCAPE)
max(BigDays.sfdfT$minCIN)
max(BigDays.sfdfT$maxBS_deep)
max(BigDays.sfdfT$maxBS_shallow)

min(BigDays.sfdfT$maxCAPE)
min(BigDays.sfdfT$minCIN)
min(BigDays.sfdfT$maxBS_deep)
min(BigDays.sfdfT$maxBS_shallow)

mean(BigDays.sfdfT$maxCAPE)
mean(BigDays.sfdfT$minCIN)
mean(BigDays.sfdfT$maxBS_deep)
mean(BigDays.sfdfT$maxBS_shallow)
```

Plot the CAPE and DLBS for the May 20, 2019 Big Day: 

*First, read in the raster. *
```{r}
library(raster)
 rb <- brick(paste0("E:/Zoe/Projects/tornenvir_climate/merged_AWIP32.20190520/merged_AWIP32.2019052018")) #<-- this is for varying NARR times
  CAPE <- raster(rb, layer = 375)
  HLCY <- raster(rb, layer = 323)
  CIN <- raster(rb, layer = 376)
  UGRD500 <- raster(rb, layer = 117) 
  VGRD500 <- raster(rb, layer = 118) 
  UGRD850 <- raster(rb, layer = 206) 
  VGRD850 <- raster(rb, layer = 207)
  UGRDsfc <- raster(rb, layer = 293) 
  VGRDsfc <- raster(rb, layer = 294)     
  DLBS <- sqrt(((UGRD500 - UGRDsfc)**2) + ((VGRD500 - VGRDsfc)**2))
  SLBS <- sqrt(((UGRD850 - UGRDsfc)**2) + ((VGRD850 - VGRDsfc)**2))
```
**Convective Available Potential energy **
```{r}
#CAPE = projectRaster(CAPE, crs = "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
May20 <- st_transform(May20, 
  crs = "+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r}
CAPE_May20 <- crop(CAPE, extent(May20))
CAPE_extent<- mask(CAPE_May20, May20)
plot(CAPE_extent)

maxCAPE <- which.max(CAPE_extent) #Returns a pixel number

#Test that this max value equals the one in BigDays.sfdfT
test <- getValues(CAPE_extent) 
test<-as.matrix(test, ncol=1)
```

```{r}
CAPEmaxpos <- xyFromCell(CAPE_extent, maxCAPE)

xy <- data.frame(CAPEmaxpos)
CAPE_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(CAPE_latlon)

CAPE_latlon <- SpatialPoints(CAPE_latlon)
proj4string(CAPE_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r}
counties <- us_counties()
states <- us_states()
```

```{r}
p1 <- tm_shape(CAPE_extent) +
  tm_raster(title = "",  n = 6, palette = "BuPu") +
  tm_format(title = expression(paste("Convective Available Potential Energy [J ",kg^-1,"]")), "World", legend.position = c("right", "bottom"),
                   attr.position = c("right", "top"),
                   legend.frame = FALSE,
                   inner.margins = c(.1, 0.1, .15, .1), #bottom, left, top
                    legend.text.size = 1, legend.width = -0.28, legend.title.size=1, legend.bg.color = "white", title.size = 1.4) +
#tm_shape(counties) +
  #tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, size = 0.8, position = c("left", "bottom"), color.dark = "gray70") +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") + 
tm_shape(states) +
  tm_borders() +
tm_shape(May20, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(CAPE_latlon) + 
  tm_symbols(size = 1.4, col = "black", shape = 22)
p1
```

**Bulk Shear**
```{r}
BS_May20 <- crop(DLBS, extent(May20))
BS_extent<- mask(BS_May20, May20)
plot(BS_extent)

maxBS <- which.max(BS_extent)
```

```{r}
BSmaxpos <- xyFromCell(BS_extent, maxBS)

xy <- data.frame(BSmaxpos)
BS_latlon <- data.frame(lon=xy$x, lat=xy$y)
print(BS_latlon)

BS_latlon <- SpatialPoints(BS_latlon)
proj4string(BS_latlon) = CRS("+proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs")
```

```{r}
p4 <- tm_shape(BS_extent) +
  tm_raster(title = "", n = 5, palette = "Reds") +
  tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ",s^-1,"]")), "World", legend.position = c("right", "bottom"),
  #tm_format(title = expression(paste("Deep-Layer Bulk Shear [m ", s^-1, "]")), "World", legend.position = c("right", "bottom"),
                   attr.position = c("right", "top"),
                   legend.frame = FALSE,
                   inner.margins = c(.1, 0.1, .15, .1), #bottom, left, top
                    legend.text.size = 1, legend.width = -0.2, legend.title.size=1, legend.bg.color = "white", title.size = 1.4) +
#tm_shape(counties) +
#  tm_borders(col = "grey") +
  tm_scale_bar(width = 0.3, size = 0.8, position = c("left", "bottom"), color.dark = "gray70") +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") + 
tm_shape(states) +
  tm_borders() +
tm_shape(May20, is.master = TRUE, projection = merc) +
  tm_borders(col = "black", lwd = 3)  +
#tm_shape(May6centroid) +
#  tm_symbols(size = 1.25, col = "black", shape = 24) +
tm_shape(BS_latlon) + 
  tm_symbols(size = 1.4, col = "black", shape = 22)
p4
```

**Combine into one figure: **
```{r}
tmap_arrange(p1, p4, ncol = 2, nrow = 1)
```

# Climate variables. 

Range of Climate Values
```{r}
max(BigDays.sfdfT$max_CSST)
max(BigDays.sfdfT$max_GAKSST)
max(BigDays.sfdfT$max_Nino34)
max(BigDays.sfdfT$NAO_daily)
max(BigDays.sfdfT$PNA_daily)
max(BigDays.sfdfT$MJO_daily)

min(BigDays.sfdfT$max_CSST)
min(BigDays.sfdfT$max_GAKSST)
min(BigDays.sfdfT$max_Nino34)
min(BigDays.sfdfT$NAO_daily)
min(BigDays.sfdfT$PNA_daily)
min(BigDays.sfdfT$MJO_daily)

mean(BigDays.sfdfT$max_CSST)
mean(BigDays.sfdfT$max_GAKSST)
mean(BigDays.sfdfT$max_Nino34)
mean(BigDays.sfdfT$NAO_daily)
mean(BigDays.sfdfT$PNA_daily)
mean(BigDays.sfdfT$MJO_daily)
```

CSST and GAKSST
```{r}
CSST_xcoord <- c(-90, -70, -70, -90)
CSST_ycoord <- c(15, 15, 25, 25)
xym <- cbind(CSST_xcoord, CSST_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
CSST_sp = SpatialPolygons(list(ps))
plot(CSST_sp)

GAKSST_xcoord <- c(-157.5,-133.1,-133.1,-157.5)
GAKSST_ycoord <- c(50.5, 50.5, 60, 60)
xym <- cbind(GAKSST_xcoord, GAKSST_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
GAKSST_sp = SpatialPolygons(list(ps))
plot(GAKSST_sp)

NINO_xcoord <- c(-170, -120, -120, -170)
NINO_ycoord <- c(-5, -5, 5, 5)
xym <- cbind(NINO_xcoord, NINO_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
NINO_sp = SpatialPolygons(list(ps))
plot(NINO_sp)

MyBorders_x <- c(-180, -60, -60, -180)
MyBorders_y <- c(-10, -10, 70, 70)
xym <- cbind(MyBorders_x, MyBorders_y)

p = Polygon(xym)
ps = Polygons(list(p),1)
MyBorders_sp = SpatialPolygons(list(ps))
plot(MyBorders_sp)
```

```{r}
data("World")

West_Hemisphere <- World %>%
  filter(continent %in% c("North America", "South America"))

SSTmap <- tm_shape(World, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "gray70", alpha = 1) +
 tm_shape(MyBorders_sp, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(alpha = 0, border.alpha = 0)+ 
tm_shape(CSST_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "blue", alpha = 0.6)+
tm_shape(GAKSST_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "darkgreen", alpha = 0.6, legend.show = TRUE)+
tm_shape(NINO_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "goldenrod2", alpha = 0.6, legend.show = TRUE) +
tm_shape(stateBorders) + 
  tm_borders(col = "gray40", alpha = 1) +
  tm_compass(size = 2, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_add_legend(type = "symbol", labels = c("Caribbean SST Zone", "Gulf of Alaska SST Zone", "Nino 3.4 SST Zone"), col = c("blue", "darkgreen", "goldenrod2"), size = 2, shape = 22, alpha = 0.6) +
  tm_layout(title = "Sea Surface Temperatures",
            title.bg.color = "white",
            title.size = 1.2, 
            legend.bg.color = "white", 
            legend.text.size = .8, 
            attr.position = c("left", "bottom"),
            legend.position = c("right", "bottom"),
            legend.stack = "horizontal",
            inner.margins = c(0.3,0.05,0.05,0))
SSTmap
```

NAO locations: 
```{r}
NAO_xcoord <- c(-70, -10, -10, -70)
NAO_ycoord <- c(55, 55, 70, 70)
xym <- cbind(NAO_xcoord, NAO_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
NAO_sp = SpatialPolygons(list(ps))
plot(NAO_sp)

NAO2_xcoord <- c(-70,-10,-10,-70)
NAO2_ycoord <- c(35, 35, 45, 45)
xym <- cbind(NAO2_xcoord, NAO2_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
NAO2_sp = SpatialPolygons(list(ps))
plot(NAO2_sp)


MyBorders_x <- c(-80, -5, -5, -80)
MyBorders_y <- c(30, 30, 75, 75)
xym <- cbind(MyBorders_x, MyBorders_y)

p = Polygon(xym)
ps = Polygons(list(p),1)
MyBorders_sp = SpatialPolygons(list(ps))
plot(MyBorders_sp)
```

```{r}
data("World")

West_Hemisphere <- World %>%
  filter(continent %in% c("North America", "South America"))

NAOmap <- tm_shape(World, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "gray70", alpha = 1) +
 tm_shape(MyBorders_sp, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(alpha = 0, border.alpha = 0)+ 
tm_shape(NAO_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "blue", alpha = 0.6)+
tm_shape(NAO2_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "darkgreen", alpha = 0.6, legend.show = TRUE)+
tm_shape(stateBorders) + 
  tm_borders(col = "gray40", alpha = 1) +
  tm_compass(size = 2, fontsize = 1, lwd = 2, color.dark = "gray70", bg.color = "white") +       
  tm_scale_bar(width = .35, size = 0.8, lwd = 1.9, color.dark = "gray70", bg.color = "white") +
  tm_add_legend(type = "symbol", labels = c("Icelandic Low", "Azores High"), col = c("blue", "darkgreen"), size = 2, shape = 22, alpha = 0.6) +
  tm_layout(title = "North Atlantic Oscillation", 
            title.size = 1.2, 
            title.bg.color = "white",
            legend.bg.color = "white", 
            legend.text.size = .8, 
            attr.position = c("right", "bottom"),
            legend.position = c("left", "bottom"),
            legend.stack = "horizontal",
            inner.margins = c(0.25,0.05,0.05,0))
```

PNA Locations: 

```{r}
PNA_xcoord <- c(-180, -140, -140, -180)
PNA_ycoord <- c(15, 15, 25, 25)
xym <- cbind(PNA_xcoord, PNA_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
PNA_sp = SpatialPolygons(list(ps))
plot(PNA_sp)

PNA2_xcoord <- c(-180, -140, -140, -180)
PNA2_ycoord <- c(40, 40, 50, 50)
xym <- cbind(PNA2_xcoord, PNA2_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
PNA2_sp = SpatialPolygons(list(ps))
plot(PNA2_sp)

PNA3_xcoord <- c(-90, -70, -70, -90)
PNA3_ycoord <- c(25, 25, 35, 35)
xym <- cbind(PNA3_xcoord, PNA3_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
PNA3_sp = SpatialPolygons(list(ps))
plot(PNA3_sp)

PNA4_xcoord <- c(-125, -105, -105, -125)
PNA4_ycoord <- c(45, 45, 60, 60)
xym <- cbind(PNA4_xcoord, PNA4_ycoord)

p = Polygon(xym)
ps = Polygons(list(p),1)
PNA4_sp = SpatialPolygons(list(ps))
plot(PNA4_sp)



MyBorders_x <- c(-180, -65, -65, -180)
MyBorders_y <- c(10, 10, 65, 65)
xym <- cbind(MyBorders_x, MyBorders_y)

p = Polygon(xym)
ps = Polygons(list(p),1)
MyBorders_sp = SpatialPolygons(list(ps))
plot(MyBorders_sp)
```

```{r}
data("World")

West_Hemisphere <- World %>%
  filter(continent %in% c("North America", "South America"))

PNAmap <- tm_shape(World, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "gray70", alpha = 1) +
 tm_shape(MyBorders_sp, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(alpha = 0, border.alpha = 0)+ 
tm_shape(PNA_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "maroon1", alpha = 0.6)+
tm_shape(PNA2_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "maroon1", alpha = 0.6, legend.show = TRUE)+
tm_shape(PNA3_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "goldenrod2", alpha = 0.7, legend.show = TRUE)+
  tm_shape(PNA4_sp, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") + 
  tm_polygons(col = "goldenrod2", alpha = 0.7, legend.show = TRUE)+
tm_shape(stateBorders) + 
  tm_borders(col = "gray40", alpha = 1) +
  tm_compass(size = 1.5, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_add_legend(type = "symbol", labels = c("Pacific Height Regions", "North American Height Regions"), col = c("maroon1", "goldenrod2"), size = 2, shape = 22, alpha = 0.7) +
  tm_layout(title = "Pacific North Atlantic",
            title.size = 1.2,
            title.bg.color = "white",
            legend.width = 0.8,
            legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"),
            legend.position = c("right", "bottom"),
            legend.stack = "horizontal",
            inner.margins = c(0.220,0.05,0,0.1))
PNAmap
```

```{r}
tmap_arrange(SSTmap, NAOmap, PNAmap, ncol = 2)
```


```{r}
#% DLBS < mean 
(dim(BigDays.sfdfT %>% filter(maxBS_deep <= mean(maxBS_deep)))[1] / dim(BigDays.sfdfT)[1]) *100

#%SLBS < mean
(dim(BigDays.sfdfT %>% filter(maxBS_shallow <= mean(maxBS_shallow)))[1] / dim(BigDays.sfdfT)[1]) *100

#% CAPE < mean
(dim(BigDays.sfdfT %>% filter(maxCAPE <= mean(maxCAPE)))[1] / dim(BigDays.sfdfT)[1]) *100
```


#The Models: 

Distributions of the response variables: 

`CAPE`
```{r}
plot_CAPE <- ggplot(BigDays.sfdfT, aes(maxCAPE)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,7000)) +
  #scale_x_log10() + 
  xlab(expression(paste("Maximum CAPE [J ", kg^-1, "]"))) +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50), labels = c("0", "10", "20", "30", "40", "50"), limits = c(0, 50)) +
  ylab("Number of Clusters") + 
  ggtitle("c") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

`Deep Layer Shear`
```{r}
plot_DLBS <- ggplot(BigDays.sfdfT, aes(maxBS_deep)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,50)) +
  #scale_x_log10() + 
  xlab(expression(paste("Maximum Deep Layer Bulk Shear [m ", s^-1, "]"))) +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50, 60), labels = c("0", "10", "20", "30", "40", "50", "60"), limits = c(0, 60)) +
  ylab("Number of Clusters") + 
  ggtitle("a") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

`Shallow Layer Shear`
```{r}
plot_SLBS <- ggplot(BigDays.sfdfT, aes(maxBS_shallow)) + 
  geom_histogram(boundary = 50, 
                 bins = 43, 
                 alpha = 0.9, 
                 color = "white", 
                 fill = "Grey40",
                 size = 0.1) +
  scale_x_continuous(expand = c(0,0), limits = c(0,40)) +
  #scale_x_log10() + 
  xlab(expression(paste("Maximum Shallow Layer Bulk Shear [m ", s^-1, "]"))) +
  scale_y_continuous(expand = c(0,0), breaks = c(0, 10,20,30,40,50), labels = c("0", "10", "20", "30", "40", "50"), limits = c(0, 50)) +
  ylab("Number of Clusters") + 
  ggtitle("b") +
  theme_bw() +
  theme(text = element_text(size=12), plot.background = element_rect(color = "grey40"), panel.border = element_rect(color = "white"), plot.margin=unit(c(0.5, 0.5, 0.5, 0.5),"cm"))
```

```{r}
ggarrange(plot_DLBS, plot_SLBS, plot_CAPE, ncol = 1, nrow = 3)
```

Does collinearity exist between the explanatory variables?:

*What is the correlation between the climate variables? *
```{r}
ClimVars <- data.frame( CSST = BigDays.sfdfT$max_CSST10day, GAKSST = BigDays.sfdfT$max_GAKSST10day, ENSO = BigDays.sfdfT$avg_Nino3410day, NAO = BigDays.sfdfT$NAO_10day, PNA = BigDays.sfdfT$PNA_10day, MJO = BigDays.sfdfT$MJO_10day)
```

*Create a figure to show correlations between the climate variables. *
```{r}
corrplot.mixed(cor(ClimVars), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

*There is a strong correlation between Caribbean sea surface temperature (ATL_SST) and Gulf of Alaska sea surface temperatures (GAK_SST). Therefore, we need to account for this. We do this by creating a new variable that is the gradient between ATL_SST and GAK_SST. *
```{r}
BigDays.sfdfT <- BigDays.sfdfT %>%
  mutate(SSTgradient_10day = max_CSST10day - max_GAKSST10day,
         SSTgradient_15day = max_CSST15day - max_GAKSST15day,
         SSTgradient_20day = max_CSST20day - max_GAKSST20day,
         SSTgradient_30day = max_CSST30day - max_GAKSST30day,
         SSTgradient_5day = max_CSST5day - max_GAKSST5day)
```


What are the values of the climate variables? 
```{r}
max(BigDays.sfdfT$max_Nino3415day)
min(BigDays.sfdfT$max_Nino3415day)
mean(BigDays.sfdfT$max_Nino3415day)

max(BigDays.sfdfT$NAO_15day)
min(BigDays.sfdfT$NAO_15day)
mean(BigDays.sfdfT$NAO_15day)

max(BigDays.sfdfT$PNA_15day)
min(BigDays.sfdfT$PNA_15day)
mean(BigDays.sfdfT$PNA_15day)

max(BigDays.sfdfT$MJO_15day)
min(BigDays.sfdfT$MJO_15day)
mean(BigDays.sfdfT$MJO_15day)

max(BigDays.sfdfT$SSTgradient_15day)
min(BigDays.sfdfT$SSTgradient_15day)
mean(BigDays.sfdfT$SSTgradient_15day)
```

*Now let's look at the correlation matrix again: *
```{r}
ClimVars2 <- data.frame(SSTgradient = BigDays.sfdfT$SSTgradient_15day, ENSO = BigDays.sfdfT$avg_Nino3415day, NAO = BigDays.sfdfT$NAO_15day, PNA = BigDays.sfdfT$PNA_15day, MJO = BigDays.sfdfT$MJO_15day)

corrplot.mixed(cor(ClimVars2), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```


This relationship indicates that the stronger the gradient in SST between the Caribbean and the Gulf of Alaska the more Arctic Sea Ice. The large correlation between these two climate variables will cause a collinearity issue in our models. As a result, one of these variables should be removed. I remove the ArcticSIE variable because it makes less physical sense. The SST gradient implies a larger magnitude of Rossby waves that can influence intense convection across the United States. 

All collinearity issues have been removed. 

##DLBS Model: 

Bivariate Relationship: 
```{r}
DLBS_env <- data.frame(SSTgradient = BigDays.sfdfT$SSTgradient_10day, ENSO = BigDays.sfdfT$avg_Nino3410day, NAO = BigDays.sfdfT$NAO_10day, PNA = BigDays.sfdfT$PNA_10day, MJO = BigDays.sfdfT$MJO_10day, Lat = BigDays.sfdfT$Lat, Lon = BigDays.sfdfT$Lon, DLBS = BigDays.sfdfT$maxBS_deep)


corrplot.mixed(cor(DLBS_env), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

Initial Model: 
```{r}
DLBS_m1 <- lm(maxBS_deep ~ SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day +  MJO_15day + Lat + Lon + Year, data = BigDays.sfdfT)
summary(DLBS_m1)
```

Seasonal Trend:
```{r}
DLBSByMonth <- BigDays.sfdfT %>% 
  group_by(Mo) %>%
  summarize(nC = n(),
            avgDLBS = mean(maxBS_deep)/nC) 
```

`Make a figure of the Mean DLBS from 1994 to 2020 by month`
```{r}
ggplot(DLBSByMonth, aes(x = as.factor(Mo), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p0 <- ggplot(DLBSByMonth, aes(x = Mo, y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
 scale_x_continuous(breaks = seq(1, 12, 1), labels = month.abb) +
  scale_y_continuous(limits = c(0, 2)) +
  coord_polar(start =0) +
  labs(x = "Month", y = expression(paste("Normalized Averages of DLBS [m ", s^-1, "]"))) +
  #ggtitle("a") +
  theme_minimal() )
```

Diurnal Trend:
```{r}
DLBSByHour <- BigDays.sfdfT %>% 
  group_by(Hour_UTC) %>%
  summarize(nC = n(),
            avgDLBS = mean(maxBS_deep))
```

`Make a figure of the total tornadoes from 1994 to 2018 by Hour`
```{r}
ggplot(DLBSByHour, aes(x = as.factor(Hour_UTC), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p1 <- ggplot(DLBSByHour, aes(x = as.factor(Hour_UTC), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 40)) +
  coord_polar(start =-0.2) +
  labs(x = "Hour (UTC)", y = expression(paste("Averaged Extremes of DLBS [m ", s^-1, "]"))) +
  theme_minimal() )
```

```{r}
ggarrange(p0, p1)
```

Annual Trend: 
```{r}
DLBSByYear <- BigDays.sfdfT %>% 
  group_by(Year) %>%
  summarize(avgDLBS = mean(maxBS_deep)) 
```

`Make a figure of the total tornadoes from 1994 to 2018 by Year`
```{r}
ggplot(DLBSByYear, aes(x = as.factor(Year), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( px <- ggplot(DLBSByYear, aes(x = as.factor(Year), y = avgDLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 40)) +
  coord_polar(start =-0.2) +
  labs(x = "Year", y = expression(paste("Averaged Extremes of DLBS [m ", s^-1, "]"))) +
  theme_minimal() )
```

Models: 

```{r}
DLBS_m2 <- lmer(maxBS_deep ~ SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day +  MJO_15day + Lat + Lon + (1|Month), data = BigDays.sfdfT)
summary(DLBS_m2)
```

```{r}
DLBS_m3 <- lmer(maxBS_deep ~ SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day + Lat + Lon + (1|Month), data = BigDays.sfdfT)
summary(DLBS_m3)
```

```{r}
DLBS_m4 <- lmer(maxBS_deep ~ SSTgradient_15day + NAO_15day + PNA_15day + Lat + Lon + (1|Month), data = BigDays.sfdfT)
summary(DLBS_m4)
```

```{r}
AIC(DLBS_m1, DLBS_m2, DLBS_m3, DLBS_m4)
```

```{r}
DLBS_model <- DLBS_m4
```


*Check the residuals of model 8 of DLBS.*
```{r}
plot(residuals(DLBS_model)) 
```
There is no relationship between the residuals.

*Make a plot of the standardized residuals for the DLBS model*
```{r}
DLBSmod.df <- fortify.merMod(model=DLBS_model, data = nlme::getData(DLBS_model))
DLBSmod.df$predDLBS <- predict(DLBS_model)

pa <- ggplot(DLBSmod.df, aes(x = .scresid)) +
  geom_histogram(binwidth = .5, color = "white", fill = "gray40") +
  xlab("Standardized Residual") + ylab("Frequency") +
  ggtitle("A") +
  theme_minimal() + theme(text = element_text(size=15))

pb <- ggplot(DLBSmod.df, aes(x = .fitted, y = .scresid, color = factor(Mo))) +
         geom_point(size = 2) +
        # scale_x_log10() +
         scale_color_discrete(name = "Month") +
  xlab(expression(paste("DLBS [m ", s^-1, "]"))) + ylab("Standardized Residual") +
  ggtitle("B") +
  theme_minimal() + theme(text = element_text(size=15))
grid.arrange(pa, pb, ncol = 2)
```
Conditional standardized residuals from the linear regression model. (A) Histogram and (B) Residuals as a function of predicted values of DLBS. The pattern in B indicates that predictions for larger values of DLBS are less accurate. 

*How does the model do compared to the actual values? *
```{r}
predictDLBS <- predict(DLBS_model)
BigDays.sfdfT$predDLBS <- predictDLBS

cor.test(BigDays.sfdfT$maxBS_deep, predictDLBS, conf.level = 0.95)
```
This model explains 56% of the variation of DLBS.

*Make a table of the model coefficients. *
```{r}
DLBSmod_coefs <- summary(DLBS_model)
xtable(DLBSmod_coefs$coefficients, digits = 3)
```

*What are the confidence intervals for the model? *
```{r}
confint(DLBS_model)
```

*Plot the observed vs Predicted values of DLBS*
```{r}
BigDays.sfdfT$Month.name <- factor(BigDays.sfdfT$Month, labels = month.name)

ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxBS_deep, 
                 y = predDLBS), #col = Month), 
             color = "gray20",
             size = 5, 
             show.legend = FALSE,  
             stroke = 0, 
             alpha = 0.8) +
  geom_smooth(method = "lm", data = BigDays.sfdfT,
            aes(x = maxBS_deep, 
                 y = predDLBS), color = "green4", se = FALSE, fullrange = TRUE) +
      #scale_colour_continuous(type = "viridis", guide = guide_colorbar(reverse = TRUE)) +
    facet_wrap(~Month.name, ncol = 3, labeller = label_value) +

  geom_abline(slope = 1, 
              size = 1.25,
              col = "blue") + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 50)) +
  ylab(expression(paste("Estimated DLBS [m ", s^-1, "]"))) + 
      xlab(expression(paste("Observed DLBS [m ", s^-1, "]"))) +
     theme_bw() + 
      theme(text = element_text(size=15), strip.background = element_rect(size = 0.5), panel.border=element_rect(colour="black",size=1), panel.background=element_rect(fill="white"), axis.text.x = element_text(angle = 45, hjust = 1)) 
```

##SLBS Model:

Seasonal Trend: 
```{r}
SLBSByMonth <- BigDays.sfdfT %>% 
  group_by(Mo) %>%
  summarize(nC = n(),
            avgSLBS = mean(maxBS_shallow)/nC) 
```

`Make a figure of the Mean SLBS from 1994 to 2020 by month`
```{r}
ggplot(SLBSByMonth, aes(x = as.factor(Mo), y = avgSLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p2 <- ggplot(SLBSByMonth, aes(x = Mo, y = avgSLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
 scale_x_continuous(breaks = seq(1, 12, 1), labels = month.abb) +
  scale_y_continuous(limits = c(0, 1.1)) +
  coord_polar(start =0) +
  labs(x = "Month", y = expression(paste("Normalized Averages of SLBS [m ", s^-1, "]"))) +
      #ggtitle("b") +
  theme_minimal() )
```

Diurnal Trend: 
```{r}
SLBSByHour <- BigDays.sfdfT %>% 
  group_by(Hour_UTC) %>%
  summarize(nC = n(),
            avgSLBS = mean(maxBS_shallow))
```

`Make a figure of the total tornadoes from 1994 to 2018 by Hour`
```{r}
ggplot(SLBSByHour, aes(x = as.factor(Hour_UTC), y = avgSLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p3 <- ggplot(SLBSByHour, aes(x = as.factor(Hour_UTC), y = avgSLBS)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 30)) +
  coord_polar(start =-0.2) +
  labs(x = "Hour (UTC)", y = expression(paste("Averaged Extremes of SLBS [m ", s^-1, "]"))) +
  theme_minimal() )
```

```{r}
ggarrange(p2, p3)
```

Initial Model: 
```{r}
SLBS_m1 <- lm(maxBS_shallow ~ SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day +  MJO_15day + Lat + Lon + Year, data = BigDays.sfdfT)
summary(DLBS_m1)

SLBSmod_coefs <- summary(SLBS_m1)
xtable(SLBSmod_coefs$coefficients, digits = 3)
```

Models: 
```{r}
SLBS_m2 <- lmer(maxBS_shallow ~ SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day +  MJO_15day + Lat + Lon + Year + (1|Month), data = BigDays.sfdfT)
summary(SLBS_m2)
```

```{r}
SLBS_m3 <- lmer(maxBS_shallow ~ SSTgradient_15day + NAO_15day + PNA_15day  + Lat + Lon + Year + (1|Month), data = BigDays.sfdfT)
summary(SLBS_m3)
```

```{r}
SLBS_m4 <- lmer(maxBS_shallow ~ SSTgradient_15day + PNA_15day  + Lat + Lon + Year + (1|Month), data = BigDays.sfdfT)
summary(SLBS_m4)
```

```{r}
AIC(SLBS_m1, SLBS_m2, SLBS_m3, SLBS_m4)
```

*Check the residuals of model 8 of SLBS.*
```{r}
SLBS_model = SLBS_m3
plot(residuals(SLBS_model)) 
```
There is no relationship between the residuals.

*Make a plot of the standardized residuals for the SLBS model*
```{r}
SLBSmod.df <- fortify.merMod(model=SLBS_model, data = nlme::getData(SLBS_model))
SLBSmod.df$predSLBS <- predict(SLBS_model)

pa <- ggplot(SLBSmod.df, aes(x = .scresid)) +
  geom_histogram(binwidth = .5, color = "white", fill = "gray40") +
  xlab("Standardized Residual") + ylab("Frequency") +
  ggtitle("A") +
  theme_minimal() + theme(text = element_text(size=15))

pb <- ggplot(SLBSmod.df, aes(x = .fitted, y = .scresid, color = factor(Mo))) +
         geom_point(size = 2) +
        # scale_x_log10() +
         scale_color_discrete(name = "Month") +
  xlab(expression(paste("SLBS [m ", s^-1, "]"))) + ylab("Standardized Residual") +
  ggtitle("B") +
  theme_minimal() + theme(text = element_text(size=15))
grid.arrange(pa, pb, ncol = 2)
```
Conditional standardized residuals from the linear regression model. (A) Histogram and (B) Residuals as a function of predicted values of SLBS. The pattern in B indicates that predictions for larger values of SLBS are less accurate. 

*How does the model do compared to the actual values? *
```{r}
predictSLBS <- predict(SLBS_model)
BigDays.sfdfT$predSLBS <- predictSLBS

cor.test(BigDays.sfdfT$maxBS_shallow, predictSLBS, conf.level = 0.95)
```
This model explains 65% of the variation of SLBS.

*Make a table of the model coefficients. *
```{r}
SLBSmod_coefs <- summary(SLBS_model)
xtable(SLBSmod_coefs$coefficients, digits = 3)
```

*What are the confidence intervals for the model? *
```{r}
confint(SLBS_model)
```

*Plot the observed vs Predicted values of SLBS*
```{r}
ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxBS_shallow, 
                 y = predSLBS), #col = Month), 
             color = "gray20",
             size = 5, 
             show.legend = FALSE,  
             stroke = 0, 
             alpha = 0.8) +
  geom_smooth(method = "lm", data = BigDays.sfdfT,
            aes(x = maxBS_shallow, 
                 y = predSLBS), color = "green4", se = FALSE, fullrange = TRUE) +
      #scale_colour_continuous(type = "viridis", guide = guide_colorbar(reverse = TRUE)) +
    facet_wrap(~Month.name, ncol = 3, labeller = label_value) +

  geom_abline(slope = 1, 
              size = 1.25,
              col = "blue") + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 40)) +
  ylab(expression(paste("Estimated SLBS [m ", s^-1, "]"))) + 
      xlab(expression(paste("Observed SLBS [m ", s^-1, "]"))) +
     theme_bw() + 
      theme(text = element_text(size=15), strip.background = element_rect(size = 0.5), panel.border=element_rect(colour="black",size=1), panel.background=element_rect(fill="white"), axis.text.x = element_text(angle = 45, hjust = 1)) 
```

##CAPE Model: 

Bivariate Relationship: 
```{r}
CAPE_env <- data.frame(SSTgradient = BigDays.sfdfT$SSTgradient_15day, ENSO = BigDays.sfdfT$avg_Nino3415day, NAO = BigDays.sfdfT$NAO_15day, PNA = BigDays.sfdfT$PNA_15day, MJO = BigDays.sfdfT$MJO_15day, Lat = BigDays.sfdfT$Lat, Lon = BigDays.sfdfT$Lon, Year = BigDays.sfdfT$Year, Hour = as.numeric(BigDays.sfdfT$Hour_UTC), CAPE = BigDays.sfdfT$maxCAPE)


corrplot.mixed(cor(CAPE_env), tl.col="black", lower.col="black", number.cex = 1, tl.cex = 1)
```

Initial Model: 
```{r}
CAPE_m1 <- lm(maxCAPE ~  SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day +  MJO_15day + Lat + Lon + Year, data = BigDays.sfdfT)
summary(CAPE_m1)

hist(CAPE_m1$residuals)
library(sm)
sm.density(CAPE_m1$residuals, model = "Normal")
```


```{r}
CAPEm1_coefs <- summary(CAPE_m1)
xtable(CAPEm1_coefs$coefficients, digits = 3)
```

Seasonal Trend: 
```{r}
CAPEByMonth <- BigDays.sfdfT %>% 
  group_by(Mo) %>%
  summarize(nC = n(),
            avgCAPE = mean(maxCAPE)/nC) 
```

`Make a figure of the total tornadoes from 1994 to 2018 by month`
```{r}
ggplot(CAPEByMonth, aes(x = as.factor(Mo), y = avgCAPE)) +
  geom_bar(stat = "identity", fill = "gray70") +
  scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p4 <- ggplot(CAPEByMonth, aes(x = as.factor(Mo), y = avgCAPE)) +
  geom_bar(stat = "identity", fill = "gray70") +
 scale_x_discrete(breaks = seq(1, 12, 1), labels = month.abb) +
  scale_y_continuous(limits = c(0, 75)) +
  coord_polar(start =0) +
  labs(x = "Month", y = expression(paste("Normalized Averages of CAPE [J  ", kg^-1, "]"))) +
      #ggtitle("c") +
  theme_minimal() )
```

Diurnal Trend: 

```{r}
CAPEByHour <- BigDays.sfdfT %>% 
  group_by(Hour_UTC) %>%
  summarize(avgCAPE = mean(maxCAPE)) 
```

`Make a figure of the total tornadoes from 1994 to 2018 by Hour`
```{r}
ggplot(CAPEByHour, aes(x = as.factor(Hour_UTC), y = avgCAPE)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p5 <- ggplot(CAPEByHour, aes(x = as.factor(Hour_UTC), y = avgCAPE)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 3500)) +
  coord_polar(start =-0.2) +
  labs(x = "Hour (UTC)", y = expression(paste("Averaged Extremes of CAPE [J  ", kg^-1, "]"))) +
  theme_minimal() )
```

```{r}
ggarrange(p0, p1, p2, p3, p4, p5, nrow = 3, ncol = 2)
```

Annual Trend: 
```{r}
CAPEByYear <- BigDays.sfdfT %>% 
  group_by(Year) %>%
  summarize(avgCAPE = mean(maxCAPE)) 
```

`Make a figure of the total tornadoes from 1994 to 2018 by Year`
```{r}
ggplot(CAPEByYear, aes(x = as.factor(Year), y = avgCAPE)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(labels = month.name) +
  scale_y_continuous(limits = c(0, NA)) +
  ylab("Number of Tornado Groups\nWith At Least 10 Tornadoes") + xlab("") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

( p6 <- ggplot(CAPEByYear, aes(x = as.factor(Year), y = avgCAPE)) +
  geom_bar(stat = "identity", fill = "gray70") +
  #scale_x_discrete(breaks = seq(0, 24, 0.5)) +
  scale_y_continuous(limits = c(0, 3000)) +
  coord_polar(start =-0.2) +
  labs(x = "Hour (UTC)", y = expression(paste("Average Extremes of CAPE [J ", kg^-1, "]"))) +
  theme_minimal() )
```

##MODELS

```{r}
CAPE_m2 <- lmer(maxCAPE ~  SSTgradient_15day + avg_Nino3415day + NAO_15day + PNA_15day +  MJO_15day + Lat + Lon + Year + (1|Month) + (1|Hour_UTC), data = BigDays.sfdfT)
summary(CAPE_m2)
```

```{r}
CAPE_m3 <- lmer(maxCAPE ~  SSTgradient_15day +  MJO_15day + Lon + (1|Month) + (1|Hour_UTC), data = BigDays.sfdfT)
summary(CAPE_m3)
```

```{r}
CAPE_model <- CAPE_m3
```

*Check the residuals of model of CAPE.*
```{r}
plot(residuals(CAPE_model)) 
```

*Make a plot of the standardized residuals for the CAPE model*
```{r}
CAPEmod.df <- fortify.merMod(model=CAPE_model, data = nlme::getData(CAPE_model), na.rm = TRUE)
CAPEmod.df$predCAPE <- predict(CAPE_model)

pa <- ggplot(CAPEmod.df, aes(x = .scresid)) +
  geom_histogram(binwidth = .5, color = "white", fill = "gray40") +
  xlab("Standardized Residual") + ylab("Frequency") +
  ggtitle("A") +
  theme_minimal() + theme(text = element_text(size=15))

pb <- ggplot(CAPEmod.df, aes(x = .fitted, y = .scresid, color = factor(Mo))) +
         geom_point(size = 2) +
        # scale_x_log10() +
         scale_color_discrete(name = "Month") +
  xlab(expression(paste("CAPE [J ", kg^-1, "]"))) + ylab("Standardized Residual") +
  ggtitle("B") +
  theme_minimal() + theme(text = element_text(size=15))
grid.arrange(pa, pb, ncol = 2)
```
Conditional standardized residuals from the linear regression model. (A) Histogram and (B) Residuals as a function of predicted values of CAPE. The pattern in B indicates that predictions for larger values of CAPE are less accurate. 

*How does the CAPE model do compared to the actual values? *
```{r}
predictCAPE <- predict(CAPE_model)
BigDays.sfdfT$predCAPE <- predictCAPE

cor.test(BigDays.sfdfT$maxCAPE, predictCAPE, conf.level = 0.95)
```
This model explains 65% of the variation of CAPE.

*Make a table of the CAPE model coefficients. *
```{r}
CAPEmod_coefs <- summary(CAPE_model)
xtable(CAPEmod_coefs$coefficients, digits = 3)
```

*What are the confidence intervals for the CAPE model? *
```{r}
confint(CAPE_model)
```

*Plot the observed vs Predicted values of CAPE*
```{r}
ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxCAPE, 
                 y = predCAPE), #col = Month), 
             color = "gray20",
             size = 5, 
             show.legend = FALSE,  
             stroke = 0, 
             alpha = 0.8) +
  geom_smooth(method = "lm", data = BigDays.sfdfT,
            aes(x = maxCAPE, 
                 y = predCAPE), color = "green4", se = FALSE, fullrange = TRUE) +
      #scale_colour_continuous(type = "viridis", guide = guide_colorbar(reverse = TRUE)) +
    facet_wrap(~Month.name, ncol = 3, labeller = label_value) +

  geom_abline(slope = 1, 
              size = 1.25,
              col = "blue") + 
  scale_y_continuous(expand = c(0,0), limits = c(-5, 6000)) +
  scale_x_continuous(limits = c(-5, 6000), breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000)) +
  ylab(expression(paste("Estimated CAPE [J ", kg^-1, "]"))) + 
      xlab(expression(paste("Observed CAPE [J ", kg^-1, "]"))) +
     theme_bw() + 
      theme(text = element_text(size=15), strip.background = element_rect(size = 0.5), panel.border=element_rect(colour="black",size=1), panel.background=element_rect(fill="white"), axis.text.x = element_text(angle = 45, hjust = 1)) 


```

```{r, eval = FALSE}
ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxCAPE, 
                 y = predCAPE), #col = Month), 
             color = "gray20",
             size = 5, 
             show.legend = FALSE,  
             stroke = 0, 
             alpha = 0.8) +
  geom_smooth(method = "lm", data = BigDays.sfdfT,
            aes(x = maxCAPE, 
                 y = predCAPE), color = "green4", se = FALSE, fullrange = TRUE) +
      #scale_colour_continuous(type = "viridis", guide = guide_colorbar(reverse = TRUE)) +
    facet_wrap(~Hour_UTC, ncol = 6, labeller = label_value) +

  geom_abline(slope = 1, 
              size = 1.25,
              col = "blue") + 
  scale_y_continuous(expand = c(0,0), limits = c(-5, 6000)) +
  scale_x_continuous(limits = c(-5, 6000), breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000)) +
  ylab(expression(paste("Estimated CAPE [J ", kg^-1, "]"))) + 
      xlab(expression(paste("Observed CAPE [J ", kg^-1, "]"))) +
     theme_bw() + 
      theme(text = element_text(size=15), strip.background = element_rect(size = 0.5), panel.border=element_rect(colour="black",size=1), panel.background=element_rect(fill="white"), axis.text.x = element_text(angle = 45, hjust = 1)) 


```

```{r}
ggplot() +
  geom_point(data = BigDays.sfdfT, 
             aes(x = maxCAPE, 
                 y = predCAPE, col = Mo), 
             size = 5, 
             show.legend = TRUE,  
             stroke = 0, 
             alpha = 0.8) +
      scale_colour_continuous(type = "viridis", guide = guide_colorbar(reverse = TRUE)) +
  geom_abline(slope = 1, 
              size = 1.25,
              col = "blue") + 
  scale_y_continuous(expand = c(0,0), limits = c(-5, 6000)) +
  scale_x_continuous(limits = c(-5, 6000), breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000)) +
  ylab(expression(paste("Estimated CAPE [J ", kg^-1, "]"))) + 
      xlab(expression(paste("Observed CAPE [J ", kg^-1, "]"))) +
     theme_bw() + 
      theme(text = element_text(size=15), strip.background = element_rect(size = 0.5), panel.border=element_rect(colour="black",size=1), panel.background=element_rect(fill="white")) 


```

*Why is there such distinction between the predictions and month?*
```{r}
BigDays.sfdfT %>%
  group_by(Mo) %>%
  summarize(minCAPE = min(maxCAPE),
            maxCAPE = max(maxCAPE), 
            difference = maxCAPE - minCAPE)
```



############################################################################
**Illustrate the CAPE, SLBS, and DLBS models:**

CAPE
```{r}
Hours <- seq(1,12,1)

newdata1 = data.frame(SSTgradient_15day = 10, MJO_15day = 1.29,  Lon = -92, Month = 4, Hour_UTC = 18)

newdata2 = data.frame(SSTgradient_15day = 25, MJO_15day = 1.29,  Lon = -72, Month = 4, Hour_UTC = 18)

newdata3 = data.frame(SSTgradient_15day = 18, MJO_15day = 1.29,  Lon = -109, Month = 4, Hour_UTC = 18)

CAPEpred1 <- predict(CAPE_model, newdata = newdata1, allow.new.levels = TRUE, type = "response")
#2364

CAPEpred2 <- predict(CAPE_model, newdata = newdata2, allow.new.levels = TRUE, type = "response")
#818


CAPEpred3 <- predict(CAPE_model, newdata = newdata3, allow.new.levels = TRUE, type = "response")
#2627

CAPEpred1 <- c(10, -92, 2364)
CAPEpred2 <- c(25, -72, 818)
CAPEpred3 <- c(18, -109, 2627)
test <- as.data.frame(rbind(CAPEpred1, CAPEpred2, CAPEpred3))
colnames(test) <- c("SSTgradient_15day", "Lon", "value")
```

Create a prediction grid.
```{r}
library(reshape2)
pgrid <- expand.grid(SSTgradient_15day = seq(0, 30, length = 100),
                     MJO_15day = 1.29,  
                     Lon = seq(-110, -70, length = 100), 
                     Month = 4, 
                     Hour_UTC = 18)
pgrid$pre <- predict(CAPE_model, newdata = pgrid, allow.new.levels = TRUE, type = "response")

pgridL = melt(pgrid, id.vars = c("SSTgradient_15day", "Lon"), measure.vars = "pre")

#x<- matrix(pre, nrow = 5001, byrow = FALSE)
e <- c(12, 12.5, 13, 13.5)
 CAPEFIG <- ggplot(pgridL, aes(x = Lon, y = SSTgradient_15day, fill = value)) +
  geom_tile( show.legend = TRUE) +
#geom_contour(aes(z = value), color = "green") + 
  #scale_fill_gradient("BuPu")
   #scale_fill_brewer(palette = "BuPu") +
  scale_fill_viridis_c(option = "D", direction = 1, limits = c(0,4000)) +
  theme_bw() +
  theme(text = element_text(size=12), legend.position="bottom", legend.key.width = unit(1, "cm"), 
        legend.background = element_rect(size=0.5)) +
     ggtitle("c") +
  xlab(expression(paste("Longitude"))) + 
  ylab(expression(paste("15-day average SST gradient"))) +
  labs(fill = expression(paste("CAPE [J ", kg^-1, "]"))) + geom_point(data = test, size = 4) 
  CAPEFIG
#e <- c(12,  12.5, 13, 13.5)
#ggplot(pgridL, aes(x = maxCAPE2, y = maxBS2, fill = value)) +
 # geom_raster(show.legend = TRUE) +
 # scale_fill_viridis_c(breaks = log(10^e), labels = c(1, 3.2, 10, 32))
```

SLBS
```{r}
SLBS_model <- SLBS_model

SLBSpred1 <- predict(SLBS_model, newdata = data.frame(SSTgradient_15day = 10, NAO_15day = -0.0197, PNA_15day = -2,  Lat = 37.13, Lon = -92, Year = 2020, Month = 4), type = "response", allow.new.levels = TRUE)
#13

SLBSpred2 <- predict(SLBS_model, newdata = data.frame(SSTgradient_15day = 25, NAO_15day = -0.0197, PNA_15day = -2,  Lat = 37.13, Lon = -72, Year = 2020, Month = 4), type = "response", allow.new.levels = TRUE)
#29.9
SLBSpred3 <- predict(SLBS_model, newdata = data.frame(SSTgradient_15day = 18, NAO_15day = -0.0197, PNA_15day = -2,  Lat = 37.13, Lon = -109, Year = 2020, Month = 4), type = "response", allow.new.levels = TRUE)

#11.4

SLBSpred1 <- c(10, -92, 13)
SLBSpred2 <- c(25, -72, 29.9)
SLBSpred3 <- c(18, -109, 11.4)
test <- as.data.frame(rbind(SLBSpred1, SLBSpred2, SLBSpred3))
colnames(test) <- c("SSTgradient_15day", "Lon", "value")
```

Create a prediction grid. 
```{r}
library(reshape2)
pgrid <- expand.grid(SSTgradient_15day = seq(0, 30, length = 100),
                     PNA_15day = -2,
                     NAO_15day = -0.0197,
                     Lat = 37.13,
                     Lon = seq(-110, -70, length = 100), 
                     Year = 2020, 
                     Month = 4)
pgrid$pre <- predict(SLBS_model, newdata = pgrid, allow.new.levels = TRUE, type = "response")

pgridL = melt(pgrid, id.vars = c("SSTgradient_15day", "Lon"), measure.vars = "pre")

#x<- matrix(pre, nrow = 5001, byrow = FALSE)
e <- c(12, 12.5, 13, 13.5)
 SLBSFIG<- ggplot(pgridL, aes(x = Lon, y = SSTgradient_15day, fill = value)) +
  geom_tile( show.legend = TRUE) +
#geom_contour(aes(z = value), color = "green") + 
  #scale_fill_gradient("BuPu")
   #scale_fill_brewer(palette = "BuPu") +
  scale_fill_viridis_c(option = "D", direction = 1, limits = c(0,45)) +
  theme_bw() +
  theme(text = element_text(size=12), legend.position="bottom", legend.key.width = unit(1, "cm"), 
        legend.background = element_rect(size=0.5)) +
     ggtitle("b") +
  xlab(expression(paste("Longitude"))) + 
  ylab(expression(paste("15-day average SST gradient"))) +
  labs(fill = expression(paste("SLBS [m ", s^-1, "]"))) + geom_point(data = test, size = 4) 
 SLBSFIG
#e <- c(12,  12.5, 13, 13.5)
#ggplot(pgridL, aes(x = maxCAPE2, y = maxBS2, fill = value)) +
 # geom_raster(show.legend = TRUE) +
 # scale_fill_viridis_c(breaks = log(10^e), labels = c(1, 3.2, 10, 32))
```

DLBS
```{r}

DLBS_model <- DLBS_model

DLBSpred1 <- predict(DLBS_model, newdata = data.frame(SSTgradient_15day = 10, avg_Nino3415day = 27.3, NAO_15day = -0.0197, PNA_15day = -2,  Lat = 37.13, Lon = -92, Year = 2020, Month = 4), type = "response", allow.new.levels = TRUE)
#21

DLBSpred2 <- predict(DLBS_model, newdata = data.frame(SSTgradient_15day = 25, avg_Nino3415day = 27.3,NAO_15day = -0.0197, PNA_15day = -2,  Lat = 37.13, Lon = -72, Year = 2020, Month = 4), type = "response", allow.new.levels = TRUE)
#37.3
DLBSpred3 <- predict(DLBS_model, newdata = data.frame(SSTgradient_15day = 18, avg_Nino3415day = 27.3,NAO_15day = -0.0197, PNA_15day = -2,  Lat = 37.13, Lon = -109, Year = 2020, Month = 4), type = "response", allow.new.levels = TRUE)

#25.6

DLBSpred1 <- c(10, -92, 21)
DLBSpred2 <- c(25, -72, 37)
DLBSpred3 <- c(18, -109, 25.6)
test <- as.data.frame(rbind(DLBSpred1, DLBSpred2, DLBSpred3))
colnames(test) <- c("SSTgradient_15day", "Lon", "value")

```

Create a prediction grid. 
```{r}
library(reshape2)
pgrid <- expand.grid(SSTgradient_15day = seq(0, 30, length = 100),
                     PNA_15day = -2,
                     avg_Nino3415day = 27.3,
                     NAO_15day = -0.0197,
                     Lat = 37.13,
                     Lon = seq(-110, -70, length = 100), 
                     Year = 2020, 
                     Month = 4)
pgrid$pre <- predict(DLBS_model, newdata = pgrid, allow.new.levels = TRUE, type = "response")

pgridL = melt(pgrid, id.vars = c("SSTgradient_15day", "Lon"), measure.vars = "pre")

#x<- matrix(pre, nrow = 5001, byrow = FALSE)
e <- c(12, 12.5, 13, 13.5)
DLBSFIG <-  ggplot(pgridL, aes(x = Lon, y = SSTgradient_15day, fill = value)) +
  geom_tile( show.legend = TRUE) +
#geom_contour(aes(z = value), color = "green") + 
  #scale_fill_gradient("BuPu")
   #scale_fill_brewer(palette = "BuPu") +
  scale_fill_viridis_c(option = "D", direction = 1, limits = c(0,45)) +
  theme_bw() +
  theme(text = element_text(size=12), legend.position="bottom", legend.key.width = unit(1, "cm"), 
        legend.background = element_rect(size=0.5)) +
  ggtitle("a") +
  xlab(expression(paste("Longitude"))) + 
  ylab(expression(paste("15-day average SST gradient"))) +
  labs(fill = expression(paste("DLBS [m ", s^-1, "]"))) + geom_point(data = test, size = 4) 

DLBSFIG
#e <- c(12,  12.5, 13, 13.5)
#ggplot(pgridL, aes(x = maxCAPE2, y = maxBS2, fill = value)) +
 # geom_raster(show.legend = TRUE) +
 # scale_fill_viridis_c(breaks = log(10^e), labels = c(1, 3.2, 10, 32))
```

Combine into a single plot
```{r}
ggarrange(DLBSFIG, SLBSFIG, CAPEFIG, ncol= 2, nrow=2)
```
